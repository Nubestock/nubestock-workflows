# Workflow reutilizable: build y deploy de Azure Static Web App
# Variables de build (VITE_*) se toman del environment y se inyectan en el build.
name: Deploy Azure Static Web App - Reusable Workflow

on:
  workflow_call:
    inputs:
      environment:
        description: "Environment a desplegar (ej. NUBESTOCK_DEV, NUBESTOCK_UAT, NUBESTOCK_PRD)"
        required: true
        type: string
      node_version:
        description: "Versión de Node.js para el build"
        required: false
        type: string
        default: "20"
      app_location:
        description: "Ruta del código de la app (relativa al repo)"
        required: false
        type: string
        default: "/"
      output_location:
        description: "Carpeta de salida del build (ej. dist)"
        required: false
        type: string
        default: "dist"
    secrets:
      # Token de deploy del Static Web App (desde Azure Portal)
      AZURE_STATIC_WEB_APPS_API_TOKEN:
        required: true
      # Para integraciones (comentarios en PRs); el caller pasa secrets.GITHUB_TOKEN
      GITHUB_TOKEN:
        required: true
      # Variables de build (Vite/React) - se inyectan en el build desde el environment
      VITE_API_BASE_URL:
        required: false
      VITE_API_TIMEOUT:
        required: false
      # Código para invocar el backend (?code=). Mismo valor que APP_KEY del backend.
      VITE_API_CODE:
        required: false

env:
  NODE_VERSION: ${{ inputs.node_version }}
  APP_LOCATION: ${{ inputs.app_location }}
  OUTPUT_LOCATION: ${{ inputs.output_location }}

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    environment:
      name: ${{ inputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          lfs: false

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build (con variables del environment)
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_API_TIMEOUT: ${{ secrets.VITE_API_TIMEOUT }}
          VITE_API_CODE: ${{ secrets.VITE_API_CODE }}
        run: npm run build

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: ${{ env.APP_LOCATION }}
          output_location: ${{ env.OUTPUT_LOCATION }}
          skip_app_build: true
